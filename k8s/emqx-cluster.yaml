apiVersion: v1
kind: ConfigMap
metadata:
  name: emqx-config
  namespace: mqtt-bench
data:
  EMQX_CLUSTER__DISCOVERY_STRATEGY: dns
  EMQX_CLUSTER__DNS__RECORD_TYPE: srv
  EMQX_CLUSTER__DNS__NAME: emqx-headless.mqtt-bench.svc.cluster.local
  EMQX_LOG__CONSOLE__LEVEL: warning
  # High performance settings
  EMQX_LISTENERS__TCP__DEFAULT__ACCEPTORS: "64"
  EMQX_LISTENERS__TCP__DEFAULT__MAX_CONNECTIONS: "500000"
  EMQX_MQTT__MAX_PACKET_SIZE: 1MB
  EMQX_MQTT__MAX_INFLIGHT: "128"
  EMQX_MQTT__MAX_MQUEUE_LEN: "10000"
  EMQX_MQTT__SHARED_SUBSCRIPTION: "true"
  EMQX_FORCE_SHUTDOWN__ENABLE: "true"
  EMQX_FORCE_SHUTDOWN__MAX_HEAP_SIZE: 1GB
  EMQX_FORCE_SHUTDOWN__MAX_MESSAGE_QUEUE_LEN: "100000"
  EMQX_OVERLOAD_PROTECTION__ENABLE: "false"
---
apiVersion: v1
kind: Service
metadata:
  name: emqx-headless
  namespace: mqtt-bench
spec:
  clusterIP: None
  selector:
    app: emqx
  ports:
    - name: mqtt
      port: 1883
    - name: mqttssl
      port: 8883
    - name: dashboard
      port: 18083
    - name: ekka
      port: 4370
    - name: dist
      port: 5370
---
apiVersion: v1
kind: Service
metadata:
  name: emqx
  namespace: mqtt-bench
spec:
  type: LoadBalancer
  selector:
    app: emqx
  ports:
    - name: mqtt
      port: 1883
      targetPort: 1883
    - name: dashboard
      port: 18083
      targetPort: 18083
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: emqx
  namespace: mqtt-bench
spec:
  serviceName: emqx-headless
  replicas: 3
  podManagementPolicy: Parallel
  selector:
    matchLabels:
      app: emqx
  template:
    metadata:
      labels:
        app: emqx
    spec:
      containers:
        - name: emqx
          image: emqx/emqx:5.3.2
          envFrom:
            - configMapRef:
                name: emqx-config
          env:
            - name: EMQX_NAME
              value: emqx
            - name: EMQX_HOST
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
          ports:
            - containerPort: 1883
              name: mqtt
            - containerPort: 8883
              name: mqttssl
            - containerPort: 18083
              name: dashboard
            - containerPort: 4370
              name: ekka
            - containerPort: 5370
              name: dist
          resources:
            requests:
              memory: "2Gi"
              cpu: "1000m"
            limits:
              memory: "4Gi"
              cpu: "2000m"
          livenessProbe:
            httpGet:
              path: /status
              port: 18083
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /status
              port: 18083
            initialDelaySeconds: 10
            periodSeconds: 5
